#include "stdafx.h"
#include <Windows.h>
#include <string.h>

#define KEY_SIZE 32
#define NEWLINE_AND_POSSIBLE_CHARACTER 3 // Used to verify if used inserted more than the KEY_SIZE.
#define MAX_KEY_SIZE (KEY_SIZE + NEWLINE_AND_POSSIBLE_CHARACTER)

/**
 * Verify if the key is valid according to the following rule:
 * key MUST BE [a-f, A-F, 0-9] < 32
 *
 * @param char *key -> Inserted key.
 * @return true if valid, false otherwise.
 */
bool is_key_valid(char *key) {
    // Verify if the inserted key is not longer than MAX_KEY_SIZE.
    if (strlen(key) > (unsigned) KEY_SIZE)
        return false;

    // Verify if it has contains only valid characters: [a-f, A-F, 0-9]
    for (unsigned int i = 0; i < strlen(key) - 1; i++) {
        char character = key[i];

        if (!((character >= 'a' && character <= 'f')
              || (character >= 'A' && character <= 'F')
              || (character >= '0' && character <= '9')))
            return false;
    }

    return true;
}

/**
 * Read the key and verify if it's valid.
 *
 * @return true if valid, false otherwise.
 */
bool read_and_verify_key() {
    char key[MAX_KEY_SIZE];

    fgets(key, MAX_KEY_SIZE, stdin);
    key[strlen(key) - 1] = '\0'; // Remove '\n' from input.

    if (!is_key_valid(key))
        return false;
    else {
        printf("%s\n", key); // Echo key.
        return true;
    }
}

/**
 * Checks whether the program is being executed in debug mode. The purpose of this
 * function is to make the code more challenging to debug.
 *
 * @return true if in debug mode, false otherwise.
 */
bool is_debugging() {
    // First debug test, using the system function.
    if (IsDebuggerPresent()) {
        return true;
    }

    // In case the first test passes in debug mode, the second verify
    // directly from the system process.
    int debug;
    CheckRemoteDebuggerPresent(GetCurrentProcess(), &debug);

    return debug ? true : false;
}

int _tmain(int argc, _TCHAR* argv[]) {
    while(1) {
        if (is_debugging()) {
            // TODO: exit program.
            printf("Debug session!\n");
        }

        if (!read_and_verify_key()) {
            // TODO: run malware.
            return 1;
        }
    }

    return 0;
}
